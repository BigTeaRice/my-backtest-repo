name: Daily Backtest and Analysis

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´æ—©ä¸Š 06:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# è®¾ç½®å¹¶å‘ç­–ç•¥
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # è¿è¡Œå›žæµ‹
  run-backtest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget build-essential
        
        # å®‰è£… TA-Lib
        wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make
        sudo make install
        cd ..
    
    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install yfinance pandas numpy backtesting TA-Lib
    
    - name: Create Output Directory
      run: |
        mkdir -p public/reports
        mkdir -p public/data
    
    - name: Run Backtest
      run: |
        echo "å¼€å§‹è¿è¡Œå›žæµ‹..."
        python main.py
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å¿…è¦æ–‡ä»¶
        if [ -f "public/index.html" ]; then
          echo "âœ… å›žæµ‹å®Œæˆ"
          echo "æŠ¥å‘Šæ•°é‡: $(find public/reports -name '*.html' 2>/dev/null | wc -l || echo 0)"
        else
          echo "âŒ å›žæµ‹å¤±è´¥"
          exit 1
        fi
    
    - name: List Generated Files
      if: success()
      run: |
        echo "ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        find public -type f -name "*.html" | head -20 || true
        echo ""
        echo "ðŸ“Š CSV æŠ¥å‘Š:"
        ls -la public/*.csv 2>/dev/null || echo "æ— CSVæ–‡ä»¶"
    
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
  
  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    needs: run-backtest
    if: success()
    
    # æ·»åŠ çŽ¯å¢ƒé…ç½®
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Display Deployment URL
      run: |
        echo "ðŸŒ ç½‘ç«™å·²éƒ¨ç½²: ${{ steps.deployment.outputs.page_url }}"
        
        # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
        cat > deployment-status.md << EOF
        # éƒ¨ç½²çŠ¶æ€
        
        - **çŠ¶æ€**: æˆåŠŸ âœ…
        - **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        - **URL**: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})
        - **å·¥ä½œæµID**: ${{ github.run_id }}
        - **æäº¤**: ${{ github.sha }}
        
        ## è®¿é—®è¯´æ˜Ž
        1. ç‚¹å‡»ä¸Šé¢çš„é“¾æŽ¥è®¿é—®å›žæµ‹ç³»ç»Ÿ
        2. é€‰æ‹©ç­–ç•¥å’Œè‚¡ç¥¨ä»£ç æŸ¥çœ‹å›žæµ‹ç»“æžœ
        3. æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡å’Œäº¤æ˜“ç»Ÿè®¡
        
        ## ä¸‹æ¬¡è¿è¡Œ
        - è‡ªåŠ¨è¿è¡Œ: æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´ 06:00)
        - æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"
        EOF
        
        echo "ðŸ“„ çŠ¶æ€æ–‡ä»¶å·²ç”Ÿæˆ"
    
    - name: Generate Summary Report
      run: |
        echo "## ðŸš€ å¤šå¸‚åœºå›žæµ‹ç³»ç»Ÿ - éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **çŠ¶æ€**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **çŽ¯å¢ƒ**: github-pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "[${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸»é¡µé¢: index.html" >> $GITHUB_STEP_SUMMARY
        echo "- ç­–ç•¥å¯¹æ¯”: strategy_comparison.csv" >> $GITHUB_STEP_SUMMARY
        echo "- å›žæµ‹æŠ¥å‘Š: reports/*.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ æ³¨æ„äº‹é¡¹" >> $GITHUB_STEP_SUMMARY
        echo "1. é¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´" >> $GITHUB_STEP_SUMMARY
        echo "2. æ•°æ®æºæ¥è‡ª Yahoo Finance" >> $GITHUB_STEP_SUMMARY
        echo "3. å›žæµ‹ç»“æžœåŸºäºŽåŽ†å²æ•°æ®" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*è‡ªåŠ¨ç”ŸæˆäºŽ $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
