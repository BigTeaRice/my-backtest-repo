name: Daily Backtest and Report Generation

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      strategy:
        description: 'ç­–ç•¥åç§°'
        required: false
        default: 'SMA'
      symbol:
        description: 'äº¤æ˜“æ ‡çš„'
        required: false
        default: 'HSI'
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  run-backtests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas numpy
        
    - name: Create Required Directories
      run: |
        mkdir -p public/reports
        mkdir -p data/cache
        
    - name: Generate Mock Reports
      run: |
        # åˆ›å»ºæ¨¡æ‹Ÿç­–ç•¥å¯¹æ¯”æ•°æ®
        echo "strategy,symbol,total_return,annual_return,sharpe_ratio,max_drawdown,win_rate,total_trades" > public/strategy_comparison.csv
        echo "SMA,HSI,0.25,0.08,1.2,-0.12,0.55,15" >> public/strategy_comparison.csv
        echo "RSI,SPY,0.18,0.06,0.9,-0.15,0.48,22" >> public/strategy_comparison.csv
        echo "MACD,BTC-USD,0.22,0.07,1.1,-0.18,0.52,18" >> public/strategy_comparison.csv
        
        # åˆ›å»ºæ¨¡æ‹ŸæŠ¥å‘Šæ–‡ä»¶
        mkdir -p public/reports
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # åˆ›å»ºHTMLæŠ¥å‘Š
        cat > public/reports/SMA_HSI_${TIMESTAMP}.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›æµ‹æŠ¥å‘Š - SMAç­–ç•¥ - æ’ç”ŸæŒ‡æ•°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .header { text-align: center; margin-bottom: 40px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .metric-card { background: #f9f9f9; padding: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š SMAç­–ç•¥å›æµ‹æŠ¥å‘Š</h1>
            <p>æ ‡çš„ï¼šæ’ç”ŸæŒ‡æ•° (HSI) | æœŸé—´ï¼š2023-01-01 è‡³ 2023-12-31</p>
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>æ€»æ”¶ç›Šç‡</h3>
                <p style="color: #4CAF50; font-size: 24px; font-weight: bold;">25.00%</p>
            </div>
            <div class="metric-card">
                <h3>å¹´åŒ–æ”¶ç›Šç‡</h3>
                <p style="color: #4CAF50; font-size: 24px; font-weight: bold;">8.00%</p>
            </div>
            <div class="metric-card">
                <h3>å¤æ™®æ¯”ç‡</h3>
                <p style="font-size: 24px; font-weight: bold;">1.20</p>
            </div>
        </div>
    </div>
</body>
</html>
EOF
        
        echo "âœ… æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        
    - name: Update HTML with Current Date
      run: |
        # æ›´æ–°index.htmlä¸­çš„æœ€åæ›´æ–°æ—¶é—´
        CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S')
        if [ -f public/index.html ]; then
            sed -i "s/æœ€åæ›´æ–°:.*/æœ€åæ›´æ–°: ${CURRENT_DATE}/" public/index.html
        else
            # å¦‚æœindex.htmlä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            cat > public/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç­–ç•¥å›æµ‹ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar-brand { font-weight: bold; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">å¤šç­–ç•¥å›æµ‹ç³»ç»Ÿ</a>
            <span class="navbar-text">æœ€åæ›´æ–°: 2023-12-05 23:30:00</span>
        </div>
    </nav>
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1 class="text-white mb-3">æ”¯æŒäº”ç§æŠ€æœ¯æŒ‡æ ‡ç­–ç•¥çš„å›æµ‹ç³»ç»Ÿ</h1>
            <p class="text-light lead">SMAåŒå‡çº¿ | RSIè¶…ä¹°è¶…å– | MACDäº¤å‰ | å¸ƒæ—å¸¦ | KDIéšæœºæŒ‡æ ‡</p>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card p-5 text-center">
                    <h3>ğŸ† å›æµ‹ç³»ç»Ÿè¿è¡ŒæˆåŠŸï¼</h3>
                    <p>ç³»ç»Ÿå·²è‡ªåŠ¨ç”Ÿæˆæœ€æ–°çš„å›æµ‹æŠ¥å‘Šå’Œç­–ç•¥å¯¹æ¯”æ•°æ®ã€‚</p>
                    <p>ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹æŠ¥å‘Šï¼š</p>
                    <div class="mt-4">
                        <a href="./reports/" class="btn btn-primary btn-lg me-3">æŸ¥çœ‹æŠ¥å‘Šç›®å½•</a>
                        <a href="./strategy_comparison.csv" class="btn btn-success btn-lg">ä¸‹è½½å¯¹æ¯”æ•°æ®</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
EOF
            sed -i "s/æœ€åæ›´æ–°:.*/æœ€åæ›´æ–°: ${CURRENT_DATE}/" public/index.html
        fi
        
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
      
    - name: Upload Reports Artifact
      uses: actions/upload-artifact@v4
      with:
        name: backtest-reports
        path: |
          public/reports/
          public/strategy_comparison.csv
        retention-days: 7
