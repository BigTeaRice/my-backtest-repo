name: Daily Backtest and Deploy

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´ 06:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  pages: write
  id-token: write

# è®¾ç½®å¹¶å‘ç­–ç•¥
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
        # éªŒè¯å®‰è£…
        python -c "import pandas; import yfinance; print('âœ… ä¾èµ–å®‰è£…æˆåŠŸ')"
    
    - name: Create output directories
      run: |
        mkdir -p public/reports
        echo "ðŸ“ ç›®å½•ç»“æž„å·²åˆ›å»º"
    
    - name: Run backtest system
      id: backtest
      run: |
        echo "å¼€å§‹è¿è¡Œå¤šç­–ç•¥å›žæµ‹ç³»ç»Ÿ..."
        echo ""
        
        # è®°å½•å¼€å§‹æ—¶é—´
        start_time=$(date +%s)
        
        # è¿è¡Œä¸»ç¨‹åº
        python main.py
        
        # è®°å½•ç»“æŸæ—¶é—´
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        echo ""
        echo "â±ï¸  è¿è¡Œæ—¶é—´: ${duration}ç§’"
        echo ""
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        if [ -f "public/index.html" ]; then
          echo "âœ… ä¸»é¡µé¢ç”ŸæˆæˆåŠŸ"
          
          # ç»Ÿè®¡æŠ¥å‘Šæ•°é‡
          html_count=$(find public/reports -name "*.html" 2>/dev/null | wc -l || echo 0)
          echo "ðŸ“Š ç”ŸæˆæŠ¥å‘Šæ•°é‡: $html_countä¸ª"
          
          # åˆ—å‡ºéƒ¨åˆ†æŠ¥å‘Š
          echo "ðŸ“‹ æŠ¥å‘Šåˆ—è¡¨:"
          find public/reports -name "*.html" 2>/dev/null | head -5 | sed 's/^/   - /'
          
          if [ $html_count -gt 5 ]; then
            echo "   ... æ›´å¤šæŠ¥å‘Š"
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "duration=${duration}" >> $GITHUB_OUTPUT
          echo "reports=${html_count}" >> $GITHUB_OUTPUT
        else
          echo "âŒ ä¸»é¡µé¢ç”Ÿæˆå¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
    
    - name: Upload Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-logs
        path: |
          public/
        retention-days: 7
  
  deploy:
    needs: run-backtest
    if: success()
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Create deployment summary
      run: |
        echo "ðŸŒ ç½‘ç«™éƒ¨ç½²å®Œæˆ!"
        echo ""
        echo "### ðŸ“Š éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**éƒ¨ç½²çŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
        echo "- è¿è¡Œæ—¶é—´: ${{ needs.run-backtest.outputs.duration }}ç§’" >> $GITHUB_STEP_SUMMARY
        echo "- ç”ŸæˆæŠ¥å‘Š: ${{ needs.run-backtest.outputs.reports }}ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- éƒ¨ç½²æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸŒ è®¿é—®åœ°å€:**" >> $GITHUB_STEP_SUMMARY
        echo "[${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“‹ ç³»ç»ŸåŠŸèƒ½:**" >> $GITHUB_STEP_SUMMARY
        echo "- 5å¤§æŠ€æœ¯æŒ‡æ ‡ç­–ç•¥: SMA, RSI, MACD, å¸ƒæž—å¸¦, KDJ" >> $GITHUB_STEP_SUMMARY
        echo "- å¤šå¸‚åœºæ”¯æŒ: ç¾Žè‚¡ã€æ¸¯è‚¡ã€æŒ‡æ•°" >> $GITHUB_STEP_SUMMARY
        echo "- å®Œæ•´å›žæµ‹æŠ¥å‘Š: å›¾è¡¨ + ç»Ÿè®¡æ•°æ®" >> $GITHUB_STEP_SUMMARY
        echo "- è‡ªåŠ¨æ›´æ–°: æ¯å¤© UTC 22:00 è‡ªåŠ¨è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*è‡ªåŠ¨ç”ŸæˆäºŽ $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
        
        # åˆ›å»ºéƒ¨ç½²çŠ¶æ€æ–‡ä»¶
        cat > public/deployment-status.json << EOF
        {{
          "status": "success",
          "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
          "url": "${{ steps.deployment.outputs.page_url }}",
          "reports": ${{ needs.run-backtest.outputs.reports }},
          "runtime": ${{ needs.run-backtest.outputs.duration }},
          "commit": "${{ github.sha }}",
          "run_id": "${{ github.run_id }}"
        }}
        EOF
    
    - name: Show deployment URL
      run: |
        echo ""
        echo "========================================"
        echo "ðŸŒ å¤šç­–ç•¥å›žæµ‹ç³»ç»Ÿå·²éƒ¨ç½²!"
        echo "========================================"
        echo ""
        echo "è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo ""
        echo "ðŸ“‹ ä½¿ç”¨æ–¹æ³•:"
        echo "1. æ‰“å¼€ä¸Šé¢çš„é“¾æŽ¥"
        echo "2. é€‰æ‹©ç­–ç•¥ (SMA/RSI/MACD/å¸ƒæž—å¸¦/KDJ)"
        echo "3. é€‰æ‹©è‚¡ç¥¨æ ‡çš„"
        echo "4. ç‚¹å‡»'åŠ è½½å›žæµ‹æŠ¥å‘Š'"
        echo "5. æŸ¥çœ‹å®Œæ•´çš„å›¾è¡¨å’Œç»Ÿè®¡æ•°æ®"
        echo ""
        echo "ðŸ’¡ æç¤º:"
        echo "- ä½¿ç”¨ Ctrl+Enter å¿«é€ŸåŠ è½½æŠ¥å‘Š"
        echo "- ä½¿ç”¨ Ctrl+S å¿«é€Ÿä¸‹è½½å®Œæ•´æŠ¥å‘Š"
        echo "- æŠ¥å‘ŠåŒ…å«äº¤äº’å¼å›¾è¡¨å’Œè¯¦ç»†æŒ‡æ ‡"
        echo ""
        echo "========================================"

# ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
generate-summary:
  needs: [run-backtest, deploy]
  if: always()
  runs-on: ubuntu-latest
  
  steps:
  - name: Generate workflow summary
    run: |
      echo "# ðŸ“Š å¤šç­–ç•¥å›žæµ‹ç³»ç»Ÿ - å·¥ä½œæµæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "## ðŸš€ æ‰§è¡Œæ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
      echo "- **å·¥ä½œæµID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
      echo "- **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      echo "- **æäº¤ç‰ˆæœ¬:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
      echo "- **è¿è¡Œæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      
      echo "## ðŸ“ˆ ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
      echo "| ä»»åŠ¡ | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
      echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
      echo "| è¿è¡Œå›žæµ‹ | ${{ needs.run-backtest.result }} | ${{ needs.run-backtest.outputs.duration }}ç§’, ${{ needs.run-backtest.outputs.reports }}ä¸ªæŠ¥å‘Š |" >> $GITHUB_STEP_SUMMARY
      echo "| éƒ¨ç½²ç½‘ç«™ | ${{ needs.deploy.result }} | ${{ steps.deployment.outputs.page_url }} |" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      
      if [ "${{ needs.run-backtest.result }}" = "success" ]; then
        echo "## ðŸŽ‰ è¿è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… å›žæµ‹ç³»ç»Ÿå·²æˆåŠŸè¿è¡Œå¹¶éƒ¨ç½²åˆ° GitHub Pages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ä¸‹æ¬¡è¿è¡Œ:**" >> $GITHUB_STEP_SUMMARY
        echo "- è‡ªåŠ¨è¿è¡Œ: æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´ 06:00)" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» 'Run workflow'" >> $GITHUB_STEP_SUMMARY
      else
        echo "## âŒ è¿è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        echo "è¯·æ£€æŸ¥æ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
      fi
      
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "---" >> $GITHUB_STEP_SUMMARY
      echo "*æŠ¥å‘Šç”ŸæˆäºŽ $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
