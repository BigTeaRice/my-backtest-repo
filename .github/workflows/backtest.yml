name: Daily Backtest and Analysis

on:
  push:
    branches: ["main"]
  schedule:
    # æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´æ—©ä¸Š 06:00)
    - cron: '0 22 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_backtest:
        description: 'è·³è¿‡å›žæµ‹åªæ›´æ–°é¡µé¢'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      update_all_data:
        description: 'æ›´æ–°æ‰€æœ‰åŽ†å²æ•°æ®'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pages: write
  id-token: write
  deployments: write

# è®¾ç½®å¹¶å‘ç­–ç•¥ï¼Œé˜²æ­¢å¤šä¸ªå·¥ä½œæµåŒæ—¶è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # é¢„æ£€æŸ¥ï¼šéªŒè¯é…ç½®
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      skip_backtest: ${{ inputs.skip_backtest }}
      update_all_data: ${{ inputs.update_all_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate configuration files
        id: check
        run: |
          echo "æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥å¿…è¦çš„é…ç½®æ–‡ä»¶
          if [ ! -f "requirements.txt" ]; then
            echo "âŒ ç¼ºå°‘ requirements.txt æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "config.py" ]; then
            echo "âŒ ç¼ºå°‘ config.py é…ç½®æ–‡ä»¶"
            exit 1
          fi
          
          if [ ! -f "main.py" ]; then
            echo "âŒ ç¼ºå°‘ main.py ä¸»ç¨‹åºæ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
          echo "should_run=true" >> $GITHUB_OUTPUT

  # æž„å»ºå’Œæµ‹è¯•
  build-and-test:
    needs: pre-check
    if: ${{ needs.pre-check.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.9", "3.10"]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        
        # å®‰è£…ç¼–è¯‘å·¥å…·
        sudo apt-get install -y \
          wget \
          build-essential \
          libfreetype6-dev \
          libpng-dev \
          libopenblas-dev \
          liblapack-dev \
          gfortran \
          pkg-config
        
        # å®‰è£… TA-Lib
        echo "å®‰è£… TA-Lib..."
        wget -q http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make -j$(nproc)
        sudo make install
        sudo ldconfig
        cd ..
        echo "âœ… TA-Lib å®‰è£…å®Œæˆ"
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python Dependencies
      run: |
        echo "å®‰è£… Python ä¾èµ–..."
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        
        # å…ˆå®‰è£…åŸºç¡€ä¾èµ–
        pip install numpy pandas yfinance
        
        # å®‰è£… requirements.txt ä¸­çš„ä¾èµ–
        pip install -r requirements.txt
        
        # æ£€æŸ¥å…³é”®åº“
        python -c "import pandas; import numpy; import yfinance; print('âœ… åŸºç¡€åº“æ£€æŸ¥é€šè¿‡')"
        
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: Verify Installation
      run: |
        echo "éªŒè¯å®‰è£…..."
        python -c "
        try:
            import pandas as pd
            import numpy as np
            import yfinance as yf
            import talib
            from backtesting import Backtest, Strategy
            print('âœ… æ‰€æœ‰æ ¸å¿ƒåº“å¯¼å…¥æˆåŠŸ')
            
            # æ£€æŸ¥ TA-Lib åŠŸèƒ½
            close = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
            rsi = talib.RSI(np.array(close), timeperiod=3)
            print(f'âœ… TA-Lib RSI è®¡ç®—æˆåŠŸ: {rsi[-1]}')
            
        except Exception as e:
            print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Run Unit Tests
      run: |
        echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
        
        # åˆ›å»ºç®€å•çš„æµ‹è¯•è„šæœ¬
        cat > test_basic.py << 'EOF'
        import pandas as pd
        import numpy as np
        from datetime import datetime, timedelta
        
        def test_data_structures():
            """æµ‹è¯•æ•°æ®ç»“æž„"""
            dates = pd.date_range(start='2020-01-01', end='2020-01-10', freq='D')
            df = pd.DataFrame({
                'Open': np.random.randn(10) + 100,
                'High': np.random.randn(10) + 105,
                'Low': np.random.randn(10) + 95,
                'Close': np.random.randn(10) + 102,
                'Volume': np.random.randint(1000, 10000, 10)
            }, index=dates)
            
            assert len(df) == 10
            assert all(col in df.columns for col in ['Open', 'High', 'Low', 'Close', 'Volume'])
            print("âœ… æ•°æ®ç»“æž„æµ‹è¯•é€šè¿‡")
            
        def test_config_import():
            """æµ‹è¯•é…ç½®å¯¼å…¥"""
            try:
                from config import STOCKS_CONFIG, BACKTEST_CONFIG
                assert isinstance(STOCKS_CONFIG, dict)
                assert isinstance(BACKTEST_CONFIG, dict)
                print("âœ… é…ç½®å¯¼å…¥æµ‹è¯•é€šè¿‡")
            except Exception as e:
                print(f"âŒ é…ç½®å¯¼å…¥å¤±è´¥: {e}")
                raise
        
        if __name__ == "__main__":
            test_data_structures()
            test_config_import()
            print("ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
        EOF
        
        python test_basic.py
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          test_basic.py
        retention-days: 1

  # è¿è¡Œå›žæµ‹å’Œåˆ†æž
  run-backtest:
    needs: [pre-check, build-and-test]
    if: ${{ needs.pre-check.outputs.should_run == 'true' && needs.pre-check.outputs.skip_backtest != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y wget build-essential
        
        # å®‰è£… TA-Lib
        wget -q http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
        tar -xzf ta-lib-0.4.0-src.tar.gz
        cd ta-lib/
        ./configure --prefix=/usr
        make -j$(nproc)
        sudo make install
        cd ..
    
    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create Output Directory
      run: |
        echo "åˆ›å»ºè¾“å‡ºç›®å½•..."
        mkdir -p public/reports
        mkdir -p public/data
        mkdir -p public/charts
    
    - name: Run Backtest
      id: backtest
      run: |
        echo "å¼€å§‹è¿è¡Œå›žæµ‹..."
        echo "è·³è¿‡å›žæµ‹: ${{ needs.pre-check.outputs.skip_backtest }}"
        echo "æ›´æ–°æ‰€æœ‰æ•°æ®: ${{ needs.pre-check.outputs.update_all_data }}"
        
        # è®°å½•å¼€å§‹æ—¶é—´
        start_time=$(date +%s)
        
        # è¿è¡Œä¸»å›žæµ‹ç¨‹åº
        python main.py 2>&1 | tee backtest.log
        
        # è®°å½•ç»“æŸæ—¶é—´å’ŒçŠ¶æ€
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        if [ -f "public/index.html" ]; then
          echo "âœ… å›žæµ‹å®Œæˆï¼Œè€—æ—¶ ${duration} ç§’"
          echo "status=success" >> $GITHUB_OUTPUT
          echo "duration=${duration}" >> $GITHUB_OUTPUT
        else
          echo "âŒ å›žæµ‹å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "duration=${duration}" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Run Analysis
      if: success()
      run: |
        echo "è¿è¡Œæ•°æ®åˆ†æž..."
        
        if [ -f "analyze.py" ]; then
          python analyze.py 2>&1 | tee analysis.log
          
          if [ $? -eq 0 ]; then
            echo "âœ… æ•°æ®åˆ†æžå®Œæˆ"
          else
            echo "âš ï¸  æ•°æ®åˆ†æžéƒ¨åˆ†å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          fi
        else
          echo "âš ï¸  æœªæ‰¾åˆ° analyze.pyï¼Œè·³è¿‡æ•°æ®åˆ†æž"
        fi
    
    - name: Check Generated Files
      if: success()
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        
        # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
        required_files=(
          "public/index.html"
          "public/strategy_comparison.csv"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
          fi
        done
        
        # ç»Ÿè®¡æŠ¥å‘Šæ•°é‡
        if [ -d "public/reports" ]; then
          report_count=$(find public/reports -name "*.html" | wc -l)
          echo "ðŸ“Š ç”ŸæˆæŠ¥å‘Šæ•°é‡: $report_count"
        fi
        
        # æ˜¾ç¤ºç›®å½•ç»“æž„
        echo "ðŸ“ å…¬å…±ç›®å½•ç»“æž„:"
        find public -type f -name "*.html" | head -10 | sed 's/^/  /'
        
        if [ $(find public -type f -name "*.html" | wc -l) -gt 10 ]; then
          echo "  ... æ›´å¤šæ–‡ä»¶"
        fi
    
    - name: Upload Backtest Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-logs
        path: |
          backtest.log
          analysis.log
        retention-days: 7
    
    - name: Upload Reports
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: backtest-reports
        path: |
          public/
        retention-days: 1

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    needs: [pre-check, run-backtest]
    if: ${{ needs.pre-check.outputs.should_run == 'true' && needs.run-backtest.result == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download Reports
      uses: actions/download-artifact@v4
      with:
        name: backtest-reports
        path: public
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Create Deployment Status
      run: |
        echo "éƒ¨ç½²å®Œæˆï¼"
        echo "é¡µé¢URL: ${{ steps.deployment.outputs.page_url }}"
        
        # èŽ·å–éƒ¨ç½²çŠ¶æ€
        if [ "${{ steps.deployment.outputs.page_url }}" != "" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸ"
          DEPLOY_STATUS="success"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          DEPLOY_STATUS="failure"
        fi
        
        # åˆ›å»ºéƒ¨ç½²çŠ¶æ€æ–‡ä»¶
        cat > public/deployment-status.json << EOF
        {
          "status": "$DEPLOY_STATUS",
          "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
          "url": "${{ steps.deployment.outputs.page_url }}",
          "commit": "${{ github.sha }}",
          "run_id": "${{ github.run_id }}"
        }
        EOF

  # ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
  generate-summary:
    needs: [pre-check, build-and-test, run-backtest, deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate Workflow Summary
      run: |
        echo "ç”Ÿæˆå·¥ä½œæµæ€»ç»“..."
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸš€ å¤šå¸‚åœºå›žæµ‹ç³»ç»Ÿ - è¿è¡ŒæŠ¥å‘Š
        
        **è¿è¡Œæ¦‚å†µ**
        - **å¼€å§‹æ—¶é—´:** $(date -d @${{ github.workflow_run.created_at }} '+%Y-%m-%d %H:%M:%S UTC')
        - **å·¥ä½œæµID:** ${{ github.run_id }}
        - **è§¦å‘æ–¹å¼:** ${{ github.event_name }}
        - **æäº¤ç‰ˆæœ¬:** ${{ github.sha }}
        
        **ä»»åŠ¡çŠ¶æ€**
        | ä»»åŠ¡ | çŠ¶æ€ | å¤‡æ³¨ |
        |------|------|------|
        | é¢„æ£€æŸ¥ | ${{ needs.pre-check.result }} | é…ç½®æ–‡ä»¶éªŒè¯ |
        | æž„å»ºæµ‹è¯• | ${{ needs.build-and-test.result }} | Python ${{ matrix.python-version }} æµ‹è¯• |
        | å›žæµ‹è¿è¡Œ | ${{ needs.run-backtest.result }} | ${{ steps.backtest.outputs.duration || 'N/A' }} ç§’ |
        | éƒ¨ç½² | ${{ needs.deploy.result }} | ${{ steps.deployment.outputs.page_url || 'æœªéƒ¨ç½²' }} |
        
        **é…ç½®å‚æ•°**
        - è·³è¿‡å›žæµ‹: ${{ needs.pre-check.outputs.skip_backtest || 'false' }}
        - æ›´æ–°æ‰€æœ‰æ•°æ®: ${{ needs.pre-check.outputs.update_all_data || 'false' }}
        
        **ç”Ÿæˆçš„æ–‡ä»¶**
        EOF
        
        # æ·»åŠ æ–‡ä»¶åˆ—è¡¨
        if [ "${{ needs.run-backtest.result }}" == "success" ]; then
          echo "âœ… **å›žæµ‹å®Œæˆ**" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸»é¡µé¢: index.html" >> $GITHUB_STEP_SUMMARY
          echo "- ç­–ç•¥å¯¹æ¯”: strategy_comparison.csv" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "public/strategy_comparison.csv" ]; then
            echo "- æ•°æ®åˆ†æž: å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **å›žæµ‹å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "**ðŸŒ è®¿é—®åœ°å€**" >> $GITHUB_STEP_SUMMARY
          echo "[${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        fi
        
        cat >> $GITHUB_STEP_SUMMARY << EOF
        
        **ä¸‹æ¬¡è¿è¡Œ**
        - è‡ªåŠ¨è¿è¡Œ: æ¯å¤© UTC 22:00 (å°æ¹¾æ—¶é—´ 06:00)
        - æ‰‹åŠ¨è§¦å‘: åœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"
        
        **æ³¨æ„äº‹é¡¹**
        1. å›žæµ‹ç»“æžœåŸºäºŽåŽ†å²æ•°æ®ï¼Œä¸ä»£è¡¨æœªæ¥è¡¨çŽ°
        2. æ•°æ®æºæ¥è‡ª Yahoo Financeï¼Œå¯èƒ½å­˜åœ¨å»¶è¿Ÿ
        3. å»ºè®®å®šæœŸæ£€æŸ¥ç­–ç•¥å‚æ•°å’Œé£Žé™©æŒ‡æ ‡
        
        ---
        
        *æœ€åŽæ›´æ–°: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*
        EOF
    
    - name: Send Notification
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const runId = context.runId;
          
          github.rest.actions.createWorkflowDispatch({
            owner,
            repo,
            workflow_id: 'backtest.yml',
            ref: 'main'
          });
          
          console.log('å·¥ä½œæµå·²é‡æ–°è°ƒåº¦');
    
    - name: Archive Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: workflow-summary
        path: ${{ github.step_summary }}
        retention-days: 30

  # æ¸…ç†æ—§æŠ¥å‘Š
  cleanup:
    needs: [pre-check, deploy]
    if: ${{ needs.pre-check.outputs.should_run == 'true' && always() }}
    runs-on: ubuntu-latest
    steps:
    - name: Cleanup Old Artifacts
      uses: actions/github-script@v7
      with:
        script: |
          // æ¸…ç†è¶…è¿‡30å¤©çš„ artifacts
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          for (const artifact of artifacts.data.artifacts) {
            const createdAt = new Date(artifact.created_at);
            if (createdAt < thirtyDaysAgo && artifact.name.includes('backtest-')) {
              console.log(`æ¸…ç†æ—§ artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
            }
          }
    
    - name: Report Completion
      run: |
        echo "ðŸŽ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼"
        echo ""
        echo "ðŸ“Š æ‰§è¡Œç»“æžœæ±‡æ€»:"
        echo "----------------------------------------"
        echo "é¢„æ£€æŸ¥: ${{ needs.pre-check.result }}"
        echo "æž„å»ºæµ‹è¯•: ${{ needs.build-and-test.result }}"
        echo "å›žæµ‹è¿è¡Œ: ${{ needs.run-backtest.result }}"
        echo "éƒ¨ç½²: ${{ needs.deploy.result }}"
        echo "æ€»ç»“ç”Ÿæˆ: ${{ job.status }}"
        echo "----------------------------------------"
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo ""
          echo "ðŸŒ ç½‘ç«™å·²éƒ¨ç½²:"
          echo "${{ steps.deployment.outputs.page_url }}"
        fi

# çŽ¯å¢ƒå˜é‡
env:
  PYTHONPATH: "${{ github.workspace }}"
  TZ: "UTC"
